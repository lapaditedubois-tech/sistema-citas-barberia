<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Administrador - Neita's Barber Shop</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <style>
        .dashboard-container {
            max-width: 1600px;
            margin: 20px auto;
            padding: 20px;
        }
        
        .dashboard-header {
            background: linear-gradient(135deg, var(--color-secondary) 0%, var(--color-primary) 100%);
            color: var(--color-light);
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .dashboard-header h1 {
            margin: 0 0 10px 0;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: var(--color-light);
            border: 2px solid var(--color-border);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        
        .stat-number {
            font-size: 42px;
            font-weight: bold;
            color: var(--color-primary);
            margin: 10px 0;
        }
        
        .stat-label {
            color: var(--color-text);
            font-size: 14px;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--color-border);
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 15px 25px;
            background: var(--color-light);
            border: 2px solid var(--color-border);
            border-bottom: none;
            border-radius: 10px 10px 0 0;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .tab:hover {
            background: rgba(212, 175, 55, 0.1);
        }
        
        .tab.active {
            background: var(--color-primary);
            color: var(--color-secondary);
            border-color: var(--color-primary);
        }
        
        .tab-content {
            display: none;
            background: var(--color-light);
            border: 2px solid var(--color-border);
            border-radius: 10px;
            padding: 25px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--color-border);
        }
        
        .section-title {
            font-size: 24px;
            color: var(--color-secondary);
            margin: 0;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background-color: var(--color-primary);
            color: var(--color-secondary);
        }
        
        .btn-primary:hover {
            background-color: var(--color-accent);
            color: var(--color-light);
        }
        
        .btn-secondary {
            background-color: var(--color-accent);
            color: var(--color-light);
        }
        
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c82333;
        }
        
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #218838;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--color-border);
        }
        
        .table th {
            background-color: var(--color-secondary);
            color: var(--color-light);
            font-weight: bold;
        }
        
        .table tr:hover {
            background-color: rgba(212, 175, 55, 0.1);
        }
        
        .badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .badge-success {
            background-color: #28a745;
            color: white;
        }
        
        .badge-warning {
            background-color: #ffc107;
            color: #000;
        }
        
        .badge-danger {
            background-color: #dc3545;
            color: white;
        }
        
        .badge-info {
            background-color: #17a2b8;
            color: white;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: var(--color-light);
            margin: 3% auto;
            padding: 30px;
            border: 2px solid var(--color-border);
            border-radius: 10px;
            width: 90%;
            max-width: 700px;
            max-height: 85vh;
            overflow-y: auto;
        }
        
        .close {
            color: var(--color-text);
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: var(--color-primary);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--color-secondary);
            font-weight: bold;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--color-border);
            border-radius: 5px;
            font-size: 14px;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            display: none;
        }
        
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--color-text);
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .logout-btn {
            background-color: #dc3545;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .logout-btn:hover {
            background-color: #c82333;
        }
        
        .search-box {
            margin-bottom: 20px;
        }
        
        .search-box input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--color-border);
            border-radius: 5px;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <nav class="navbar">
                <div class="logo">
                    <h1>Neita's</h1>
                    <span>BARBER SHOP</span>
                </div>
                <ul class="nav-menu">
                    <li><a href="/admin/dashboard">Admin Dashboard</a></li>
                    <li><a href="/" class="btn-login">Inicio</a></li>
                    <li><button onclick="logout()" class="logout-btn">Cerrar Sesión</button></li>
                </ul>
            </nav>
        </div>
    </header>

    <div class="dashboard-container">
        <!-- Dashboard Header -->
        <div class="dashboard-header">
            <h1>Dashboard Administrador</h1>
            <p id="welcomeMessage">Panel de Control Total</p>
        </div>

        <!-- Alert -->
        <div id="alert" class="alert"></div>

        <!-- Estadísticas -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Usuarios</div>
                <div class="stat-number" id="statUsuarios">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Profesionales</div>
                <div class="stat-number" id="statProfesionales">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Servicios</div>
                <div class="stat-number" id="statServicios">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Citas Totales</div>
                <div class="stat-number" id="statCitas">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Productos</div>
                <div class="stat-number" id="statProductos">0</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <div class="tab active" onclick="cambiarTab('usuarios')">Usuarios</div>
            <div class="tab" onclick="cambiarTab('profesionales')">Profesionales</div>
            <div class="tab" onclick="cambiarTab('servicios')">Servicios</div>
            <div class="tab" onclick="cambiarTab('citas')">Citas</div>
            <div class="tab" onclick="cambiarTab('productos')">Productos</div>
        </div>

        <!-- Tab Content: Usuarios -->
        <div id="tab-usuarios" class="tab-content active">
            <div class="section-header">
                <h2 class="section-title">Gestión de Usuarios</h2>
                <button class="btn btn-primary" onclick="abrirModalUsuario()">+ Nuevo Usuario</button>
            </div>
            <div class="search-box">
                <input type="text" id="searchUsuarios" placeholder="Buscar usuarios..." onkeyup="filtrarUsuarios()">
            </div>
            <div id="usuariosContainer">
                <div class="empty-state"><p>Cargando...</p></div>
            </div>
        </div>

        <!-- Tab Content: Profesionales -->
        <div id="tab-profesionales" class="tab-content">
            <div class="section-header">
                <h2 class="section-title">Gestión de Profesionales</h2>
                <button class="btn btn-primary" onclick="abrirModalProfesional()">+ Nuevo Profesional</button>
            </div>
            <div id="profesionalesContainer">
                <div class="empty-state"><p>Cargando...</p></div>
            </div>
        </div>

        <!-- Tab Content: Servicios -->
        <div id="tab-servicios" class="tab-content">
            <div class="section-header">
                <h2 class="section-title">Gestión de Servicios</h2>
                <button class="btn btn-primary" onclick="abrirModalServicio()">+ Nuevo Servicio</button>
            </div>
            <div id="serviciosContainer">
                <div class="empty-state"><p>Cargando...</p></div>
            </div>
        </div>

        <!-- Tab Content: Citas -->
        <div id="tab-citas" class="tab-content">
            <div class="section-header">
                <h2 class="section-title">Gestión de Citas</h2>
            </div>
            <div class="search-box">
                <input type="text" id="searchCitas" placeholder="Buscar citas..." onkeyup="filtrarCitas()">
            </div>
            <div id="citasContainer">
                <div class="empty-state"><p>Cargando...</p></div>
            </div>
        </div>

        <!-- Tab Content: Productos -->
        <div id="tab-productos" class="tab-content">
            <div class="section-header">
                <h2 class="section-title">Gestión de Productos</h2>
                <button class="btn btn-primary" onclick="abrirModalProducto()">+ Nuevo Producto</button>
            </div>
            <div id="productosContainer">
                <div class="empty-state"><p>Cargando...</p></div>
            </div>
        </div>
    </div>

    <!-- Modal Usuario -->
    <div id="modalUsuario" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModalUsuario()">&times;</span>
            <h2 id="tituloModalUsuario">Nuevo Usuario</h2>
            <form id="formUsuario">
                <input type="hidden" id="usuarioId">
                <div class="form-group">
                    <label for="usuarioNombre">Nombre *</label>
                    <input type="text" id="usuarioNombre" required>
                </div>
                <div class="form-group">
                    <label for="usuarioEmail">Email *</label>
                    <input type="email" id="usuarioEmail" required>
                </div>
                <div class="form-group" id="passwordGroup">
                    <label for="usuarioPassword">Contraseña *</label>
                    <input type="password" id="usuarioPassword" minlength="6">
                </div>
                <div class="form-group">
                    <label for="usuarioTelefono">Teléfono</label>
                    <input type="tel" id="usuarioTelefono">
                </div>
                <div class="form-group">
                    <label for="usuarioRoles">Roles *</label>
                    <select id="usuarioRoles" multiple required>
                        <option value="CLIENTE">Cliente</option>
                        <option value="PROFESIONAL">Profesional</option>
                        <option value="ADMIN">Administrador</option>
                    </select>
                    <small>Mantén Ctrl/Cmd para seleccionar múltiples</small>
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn btn-primary">Guardar</button>
                    <button type="button" class="btn btn-secondary" onclick="cerrarModalUsuario()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Profesional -->
    <div id="modalProfesional" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModalProfesional()">&times;</span>
            <h2 id="tituloModalProfesional">Nuevo Profesional</h2>
            <form id="formProfesional">
                <input type="hidden" id="profesionalId">
                <div class="form-group">
                    <label for="profesionalUsuarioId">Usuario *</label>
                    <select id="profesionalUsuarioId" required>
                        <option value="">Seleccione un usuario</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="profesionalEspecialidad">Especialidad *</label>
                    <textarea id="profesionalEspecialidad" required placeholder="Ej: Cortes clásicos, diseño de barba..."></textarea>
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn btn-primary">Guardar</button>
                    <button type="button" class="btn btn-secondary" onclick="cerrarModalProfesional()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Servicio -->
    <div id="modalServicio" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModalServicio()">&times;</span>
            <h2 id="tituloModalServicio">Nuevo Servicio</h2>
            <form id="formServicio">
                <input type="hidden" id="servicioId">
                <div class="form-group">
                    <label for="servicioNombre">Nombre *</label>
                    <input type="text" id="servicioNombre" required>
                </div>
                <div class="form-group">
                    <label for="servicioDescripcion">Descripción *</label>
                    <textarea id="servicioDescripcion" required></textarea>
                </div>
                <div class="form-group">
                    <label for="servicioDuracion">Duración *</label>
                    <input type="text" id="servicioDuracion" required placeholder="Ej: 45 minutos">
                </div>
                <div class="form-group">
                    <label for="servicioPrecio">Precio (COP) *</label>
                    <input type="number" id="servicioPrecio" min="0" step="1000" required>
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn btn-primary">Guardar</button>
                    <button type="button" class="btn btn-secondary" onclick="cerrarModalServicio()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Producto -->
    <div id="modalProducto" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModalProducto()">&times;</span>
            <h2 id="tituloModalProducto">Nuevo Producto</h2>
            <form id="formProducto">
                <input type="hidden" id="productoId">
                <div class="form-group">
                    <label for="productoNombre">Nombre *</label>
                    <input type="text" id="productoNombre" required>
                </div>
                <div class="form-group">
                    <label for="productoDescripcion">Descripción *</label>
                    <textarea id="productoDescripcion" required></textarea>
                </div>
                <div class="form-group">
                    <label for="productoPrecio">Precio (COP) *</label>
                    <input type="number" id="productoPrecio" min="0" step="1000" required>
                </div>
                <div class="form-group">
                    <label for="productoStock">Stock *</label>
                    <input type="number" id="productoStock" min="0" required>
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn btn-primary">Guardar</button>
                    <button type="button" class="btn btn-secondary" onclick="cerrarModalProducto()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Estado Cita -->
    <div id="modalCita" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModalCita()">&times;</span>
            <h2>Actualizar Estado de Cita</h2>
            <form id="formCita">
                <input type="hidden" id="citaId">
                <div class="form-group">
                    <label for="citaEstado">Estado *</label>
                    <select id="citaEstado" required>
                        <option value="PENDIENTE">Pendiente</option>
                        <option value="CONFIRMADA">Confirmada</option>
                        <option value="COMPLETADA">Completada</option>
                        <option value="CANCELADA">Cancelada</option>
                    </select>
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn btn-primary">Actualizar</button>
                    <button type="button" class="btn btn-secondary" onclick="cerrarModalCita()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <script th:src="@{/js/main.js}"></script>
    <script>
        let usuarioData = null;
        let todosUsuarios = [];
        let todasCitas = [];

        // Verificar autenticación y rol
        window.addEventListener('DOMContentLoaded', () => {
            const usuarioStr = localStorage.getItem('usuario');
            if (!usuarioStr) {
                window.location.href = '/login';
                return;
            }

            usuarioData = JSON.parse(usuarioStr);
            
            // Verificar que sea administrador
            if (!usuarioData.roles || !usuarioData.roles.includes('ADMIN')) {
                showAlert('No tienes permisos para acceder a esta página', 'error');
                setTimeout(() => window.location.href = '/login', 2000);
                return;
            }

            document.getElementById('welcomeMessage').textContent = `Bienvenido, ${usuarioData.nombre}`;
            cargarTodosDatos();
        });

        async function cargarTodosDatos() {
            await Promise.all([
                cargarEstadisticas(),
                cargarUsuarios(),
                cargarProfesionales(),
                cargarServicios(),
                cargarCitas(),
                cargarProductos()
            ]);
        }

        async function cargarEstadisticas() {
            try {
                const token = localStorage.getItem('authToken');
                
                // Usuarios
                const usuariosResp = await fetch('http://localhost:8088/api/usuarios', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const usuarios = await usuariosResp.json();
                document.getElementById('statUsuarios').textContent = usuarios.length;

                // Profesionales
                const profesionalesResp = await fetch('http://localhost:8088/api/profesionales/activos', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const profesionales = await profesionalesResp.json();
                document.getElementById('statProfesionales').textContent = profesionales.length;

                // Servicios
                const serviciosResp = await fetch('http://localhost:8088/api/servicios/activos');
                const servicios = await serviciosResp.json();
                document.getElementById('statServicios').textContent = servicios.length;

                // Citas
                const citasResp = await fetch('http://localhost:8088/api/citas', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const citas = await citasResp.json();
                document.getElementById('statCitas').textContent = citas.length;

                // Productos
                const productosResp = await fetch('http://localhost:8088/api/productos', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const productos = await productosResp.json();
                document.getElementById('statProductos').textContent = productos.length;

            } catch (error) {
                console.error('Error al cargar estadísticas:', error);
            }
        }

        function cambiarTab(tabName) {
            // Ocultar todos los tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Mostrar tab seleccionado
            document.getElementById(`tab-${tabName}`).classList.add('active');
            event.target.classList.add('active');
        }

        // ===== USUARIOS =====
        async function cargarUsuarios() {
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch('http://localhost:8088/api/usuarios', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    todosUsuarios = await response.json();
                    mostrarUsuarios(todosUsuarios);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function mostrarUsuarios(usuarios) {
            const container = document.getElementById('usuariosContainer');
            
            if (usuarios.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No hay usuarios registrados</p></div>';
                return;
            }

            let html = '<table class="table"><thead><tr><th>Nombre</th><th>Email</th><th>Teléfono</th><th>Roles</th><th>Estado</th><th>Acciones</th></tr></thead><tbody>';
            
            usuarios.forEach(usuario => {
                const rolesStr = usuario.roles ? usuario.roles.join(', ') : 'Sin roles';
                html += `
                    <tr>
                        <td>${usuario.nombre}</td>
                        <td>${usuario.email}</td>
                        <td>${usuario.telefono || 'N/A'}</td>
                        <td>${rolesStr}</td>
                        <td><span class="badge ${usuario.activo ? 'badge-success' : 'badge-danger'}">${usuario.activo ? 'Activo' : 'Inactivo'}</span></td>
                        <td>
                            <div class="btn-group">
                                <button class="btn btn-secondary" onclick="editarUsuario(${usuario.id})">Editar</button>
                                <button class="btn btn-danger" onclick="eliminarUsuario(${usuario.id})">Eliminar</button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function filtrarUsuarios() {
            const searchTerm = document.getElementById('searchUsuarios').value.toLowerCase();
            const usuariosFiltrados = todosUsuarios.filter(usuario => 
                usuario.nombre.toLowerCase().includes(searchTerm) ||
                usuario.email.toLowerCase().includes(searchTerm)
            );
            mostrarUsuarios(usuariosFiltrados);
        }

        function abrirModalUsuario() {
            document.getElementById('tituloModalUsuario').textContent = 'Nuevo Usuario';
            document.getElementById('formUsuario').reset();
            document.getElementById('usuarioId').value = '';
            document.getElementById('passwordGroup').style.display = 'block';
            document.getElementById('usuarioPassword').required = true;
            document.getElementById('modalUsuario').style.display = 'block';
        }

        function cerrarModalUsuario() {
            document.getElementById('modalUsuario').style.display = 'none';
        }

        async function editarUsuario(id) {
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`http://localhost:8088/api/usuarios/${id}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const usuario = await response.json();
                    document.getElementById('tituloModalUsuario').textContent = 'Editar Usuario';
                    document.getElementById('usuarioId').value = usuario.id;
                    document.getElementById('usuarioNombre').value = usuario.nombre;
                    document.getElementById('usuarioEmail').value = usuario.email;
                    document.getElementById('usuarioTelefono').value = usuario.telefono || '';
                    
                    // Seleccionar roles
                    const rolesSelect = document.getElementById('usuarioRoles');
                    Array.from(rolesSelect.options).forEach(option => {
                        option.selected = usuario.roles && usuario.roles.includes(option.value);
                    });
                    
                    document.getElementById('passwordGroup').style.display = 'none';
                    document.getElementById('usuarioPassword').required = false;
                    document.getElementById('modalUsuario').style.display = 'block';
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('Error al cargar usuario', 'error');
            }
        }

        document.getElementById('formUsuario').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const usuarioId = document.getElementById('usuarioId').value;
            const rolesSelect = document.getElementById('usuarioRoles');
            const rolesSeleccionados = Array.from(rolesSelect.selectedOptions).map(option => option.value);
            
            const data = {
                nombre: document.getElementById('usuarioNombre').value,
                email: document.getElementById('usuarioEmail').value,
                telefono: document.getElementById('usuarioTelefono').value,
                roles: rolesSeleccionados
            };

            if (!usuarioId) {
                data.password = document.getElementById('usuarioPassword').value;
            }

            try {
                const token = localStorage.getItem('authToken');
                const url = usuarioId 
                    ? `http://localhost:8088/api/usuarios/${usuarioId}`
                    : 'http://localhost:8088/api/usuarios';
                
                const method = usuarioId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    showAlert(usuarioId ? 'Usuario actualizado' : 'Usuario creado', 'success');
                    cerrarModalUsuario();
                    cargarUsuarios();
                    cargarEstadisticas();
                } else {
                    const error = await response.json();
                    showAlert(error.message || 'Error al guardar usuario', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('Error de conexión', 'error');
            }
        });

        async function eliminarUsuario(id) {
            if (!confirm('¿Estás seguro de eliminar este usuario?')) return;

            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`http://localhost:8088/api/usuarios/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    showAlert('Usuario eliminado', 'success');
                    cargarUsuarios();
                    cargarEstadisticas();
                } else {
                    showAlert('Error al eliminar usuario', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('Error de conexión', 'error');
            }
        }

        // ===== PROFESIONALES =====
        async function cargarProfesionales() {
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch('http://localhost:8088/api/profesionales/activos', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const profesionales = await response.json();
                    mostrarProfesionales(profesionales);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function mostrarProfesionales(profesionales) {
            const container = document.getElementById('profesionalesContainer');
            
            if (profesionales.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No hay profesionales registrados</p></div>';
                return;
            }

            let html = '<table class="table"><thead><tr><th>Nombre</th><th>Email</th><th>Especialidad</th><th>Estado</th><th>Acciones</th></tr></thead><tbody>';
            
            profesionales.forEach(prof => {
                html += `
                    <tr>
                        <td>${prof.usuarioNombre}</td>
                        <td>${prof.usuarioEmail}</td>
                        <td>${prof.especialidad}</td>
                        <td><span class="badge ${prof.activo ? 'badge-success' : 'badge-danger'}">${prof.activo ? 'Activo' : 'Inactivo'}</span></td>
                        <td>
                            <div class="btn-group">
                                <button class="btn btn-secondary" onclick="editarProfesional(${prof.id})">Editar</button>
                                <button class="btn btn-danger" onclick="eliminarProfesional(${prof.id})">Eliminar</button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        async function abrirModalProfesional() {
            document.getElementById('tituloModalProfesional').textContent = 'Nuevo Profesional';
            document.getElementById('formProfesional').reset();
            document.getElementById('profesionalId').value = '';
            
            // Cargar usuarios disponibles
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch('http://localhost:8088/api/usuarios', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const usuarios = await response.json();
                    const select = document.getElementById('profesionalUsuarioId');
                    select.innerHTML = '<option value="">Seleccione un usuario</option>';
                    usuarios.forEach(usuario => {
                        select.innerHTML += `<option value="${usuario.id}">${usuario.nombre} (${usuario.email})</option>`;
                    });
                }
            } catch (error) {
                console.error('Error:', error);
            }
            
            document.getElementById('modalProfesional').style.display = 'block';
        }

        function cerrarModalProfesional() {
            document.getElementById('modalProfesional').style.display = 'none';
        }

        async function editarProfesional(id) {
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`http://localhost:8088/api/profesionales/${id}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const profesional = await response.json();
                    document.getElementById('tituloModalProfesional').textContent = 'Editar Profesional';
                    document.getElementById('profesionalId').value = profesional.id;
                    document.getElementById('profesionalUsuarioId').value = profesional.usuarioId;
                    document.getElementById('profesionalEspecialidad').value = profesional.especialidad;
                    
                    await abrirModalProfesional();
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('Error al cargar profesional', 'error');
            }
        }

        document.getElementById('formProfesional').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const profesionalId = document.getElementById('profesionalId').value;
            const data = {
                usuarioId: parseInt(document.getElementById('profesionalUsuarioId').value),
                especialidad: document.getElementById('profesionalEspecialidad').value
            };

            try {
                const token = localStorage.getItem('authToken');
                const url = profesionalId 
                    ? `http://localhost:8088/api/profesionales/${profesionalId}`
                    : 'http://localhost:8088/api/profesionales';
                
                const method = profesionalId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    showAlert(profesionalId ? 'Profesional actualizado' : 'Profesional creado', 'success');
                    cerrarModalProfesional();
                    cargarProfesionales();
                    cargarEstadisticas();
                } else {
                    const error = await response.json();
                    showAlert(error.message || 'Error al guardar profesional', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('Error de conexión', 'error');
            }
        });

        async function eliminarProfesional(id) {
            if (!confirm('¿Estás seguro de eliminar este profesional?')) return;

            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`http://localhost:8088/api/profesionales/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    showAlert('Profesional eliminado', 'success');
                    cargarProfesionales();
                    cargarEstadisticas();
                } else {
                    showAlert('Error al eliminar profesional', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('Error de conexión', 'error');
            }
        }

        // ===== SERVICIOS =====
        async function cargarServicios() {
            try {
                const response = await fetch('http://localhost:8088/api/servicios/activos');

                if (response.ok) {
                    const servicios = await response.json();
                    mostrarServicios(servicios);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function mostrarServicios(servicios) {
            const container = document.getElementById('serviciosContainer');
            
            if (servicios.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No hay servicios registrados</p></div>';
                return;
            }

            let html = '<table class="table"><thead><tr><th>Nombre</th><th>Descripción</th><th>Duración</th><th>Precio</th><th>Estado</th><th>Acciones</th></tr></thead><tbody>';
            
            servicios.forEach(servicio => {
                html += `
                    <tr>
                        <td>${servicio.nombre}</td>
                        <td>${servicio.descripcion}</td>
                        <td>${servicio.duracion}</td>
                        <td>$${servicio.precio.toLocaleString('es-CO')}</td>
                        <td><span class="badge ${servicio.activo ? 'badge-success' : 'badge-danger'}">${servicio.activo ? 'Activo' : 'Inactivo'}</span></td>
                        <td>
                            <div class="btn-group">
                                <button class="btn btn-secondary" onclick="editarServicio(${servicio.id})">Editar</button>
                                <button class="btn btn-danger" onclick="eliminarServicio(${servicio.id})">Eliminar</button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function abrirModalServicio() {
            document.getElementById('tituloModalServicio').textContent = 'Nuevo Servicio';
            document.getElementById('formServicio').reset();
            document.getElementById('servicioId').value = '';
            document.getElementById('modalServicio').style.display = 'block';
        }

        function cerrarModalServicio() {
            document.getElementById('modalServicio').style.display = 'none';
        }

        async function editarServicio(id) {
            try {
                const response = await fetch(`http://localhost:8088/api/servicios/${id}`);

                if (response.ok) {
                    const servicio = await response.json();
                    document.getElementById('tituloModalServicio').textContent = 'Editar Servicio';
                    document.getElementById('servicioId').value = servicio.id;
                    document.getElementById('servicioNombre').value = servicio.nombre;
                    document.getElementById('servicioDescripcion').value = servicio.descripcion;
                    document.getElementById('servicioDuracion').value = servicio.duracion;
                    document.getElementById('servicioPrecio').value = servicio.precio;
                    document.getElementById('modalServicio').style.display = 'block';
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('Error al cargar servicio', 'error');
            }
        }

        document.getElementById('formServicio').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const servicioId = document.getElementById('servicioId').value;
            const data = {
                nombre: document.getElementById('servicioNombre').value,
                descripcion: document.getElementById('servicioDescripcion').value,
                duracion: document.getElementById('servicioDuracion').value,
                precio: parseFloat(document.getElementById('servicioPrecio').value)
            };

            try {
                const token = localStorage.getItem('authToken');
                const url = servicioId 
                    ? `http://localhost:8088/api/servicios/${servicioId}`
                    : 'http://localhost:8088/api/servicios';
                
                const method = servicioId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    showAlert(servicioId ? 'Servicio actualizado' : 'Servicio creado', 'success');
                    cerrarModalServicio();
                    cargarServicios();
                    cargarEstadisticas();
                } else {
                    const error = await response.json();
                    showAlert(error.message || 'Error al guardar servicio', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('Error de conexión', 'error');
            }
        });

        async function eliminarServicio(id) {
            if (!confirm('¿Estás seguro de eliminar este servicio?')) return;

            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`http://localhost:8088/api/servicios/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    showAlert('Servicio eliminado', 'success');
                    cargarServicios();
                    cargarEstadisticas();
                } else {
                    showAlert('Error al eliminar servicio', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('Error de conexión', 'error');
            }
        }

        // ===== CITAS =====
        async function cargarCitas() {
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch('http://localhost:8088/api/citas', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    todasCitas = await response.json();
                    mostrarCitas(todasCitas);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function mostrarCitas(citas) {
            const container = document.getElementById('citasContainer');
            
            if (citas.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No hay citas registradas</p></div>';
                return;
            }

            let html = '<table class="table"><thead><tr><th>Cliente</th><th>Profesional</th><th>Servicio</th><th>Fecha/Hora</th><th>Estado</th><th>Acciones</th></tr></thead><tbody>';
            
            citas.forEach(cita => {
                const fecha = new Date(cita.fechaHora);
                const estadoBadge = {
                    'PENDIENTE': 'badge-warning',
                    'CONFIRMADA': 'badge-info',
                    'COMPLETADA': 'badge-success',
                    'CANCELADA': 'badge-danger'
                };
                
                html += `
                    <tr>
                        <td>${cita.usuarioNombre}</td>
                        <td>${cita.profesionalNombre}</td>
                        <td>${cita.servicioNombre}</td>
                        <td>${fecha.toLocaleString('es-CO')}</td>
                        <td><span class="badge ${estadoBadge[cita.estado]}">${cita.estado}</span></td>
                        <td>
                            <div class="btn-group">
                                <button class="btn btn-secondary" onclick="abrirModalCita(${cita.id}, '${cita.estado}')">Actualizar</button>
                                <button class="btn btn-danger" onclick="eliminarCita(${cita.id})">Eliminar</button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function filtrarCitas() {
            const searchTerm = document.getElementById('searchCitas').value.toLowerCase();
            const citasFiltradas = todasCitas.filter(cita => 
                cita.usuarioNombre.toLowerCase().includes(searchTerm) ||
                cita.profesionalNombre.toLowerCase().includes(searchTerm) ||
                cita.servicioNombre.toLowerCase().includes(searchTerm)
            );
            mostrarCitas(citasFiltradas);
        }

        function abrirModalCita(citaId, estadoActual) {
            document.getElementById('citaId').value = citaId;
            document.getElementById('citaEstado').value = estadoActual;
            document.getElementById('modalCita').style.display = 'block';
        }

        function cerrarModalCita() {
            document.getElementById('modalCita').style.display = 'none';
        }

        document.getElementById('formCita').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const citaId = document.getElementById('citaId').value;
            const estado = document.getElementById('citaEstado').value;

            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`http://localhost:8088/api/citas/${citaId}/estado`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ estado: estado })
                });

                if (response.ok) {
                    showAlert('Estado actualizado', 'success');
                    cerrarModalCita();
                    cargarCitas();
                } else {
                    showAlert('Error al actualizar estado', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('Error de conexión', 'error');
            }
        });

        async function eliminarCita(id) {
            if (!confirm('¿Estás seguro de eliminar esta cita?')) return;

            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`http://localhost:8088/api/citas/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    showAlert('Cita eliminada', 'success');
                    cargarCitas();
                    cargarEstadisticas();
                } else {
                    showAlert('Error al eliminar cita', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('Error de conexión', 'error');
            }
        }

        // ===== PRODUCTOS =====
        async function cargarProductos() {
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch('http://localhost:8088/api/productos', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const productos = await response.json();
                    mostrarProductos(productos);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function mostrarProductos(productos) {
            const container = document.getElementById('productosContainer');
            
            if (productos.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No hay productos registrados</p></div>';
                return;
            }

            let html = '<table class="table"><thead><tr><th>Nombre</th><th>Descripción</th><th>Precio</th><th>Stock</th><th>Estado</th><th>Acciones</th></tr></thead><tbody>';
            
            productos.forEach(producto => {
                html += `
                    <tr>
                        <td>${producto.nombre}</td>
                        <td>${producto.descripcion}</td>
                        <td>$${producto.precio.toLocaleString('es-CO')}</td>
                        <td>${producto.stock}</td>
                        <td><span class="badge ${producto.disponible ? 'badge-success' : 'badge-danger'}">${producto.disponible ? 'Disponible' : 'No disponible'}</span></td>
                        <td>
                            <div class="btn-group">
                                <button class="btn btn-secondary" onclick="editarProducto(${producto.id})">Editar</button>
                                <button class="btn btn-danger" onclick="eliminarProducto(${producto.id})">Eliminar</button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function abrirModalProducto() {
            document.getElementById('tituloModalProducto').textContent = 'Nuevo Producto';
            document.getElementById('formProducto').reset();
            document.getElementById('productoId').value = '';
            document.getElementById('modalProducto').style.display = 'block';
        }

        function cerrarModalProducto() {
            document.getElementById('modalProducto').style.display = 'none';
        }

        async function editarProducto(id) {
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`http://localhost:8088/api/productos/${id}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const producto = await response.json();
                    document.getElementById('tituloModalProducto').textContent = 'Editar Producto';
                    document.getElementById('productoId').value = producto.id;
                    document.getElementById('productoNombre').value = producto.nombre;
                    document.getElementById('productoDescripcion').value = producto.descripcion;
                    document.getElementById('productoPrecio').value = producto.precio;
                    document.getElementById('productoStock').value = producto.stock;
                    document.getElementById('modalProducto').style.display = 'block';
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('Error al cargar producto', 'error');
            }
        }

        document.getElementById('formProducto').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const productoId = document.getElementById('productoId').value;
            const data = {
                nombre: document.getElementById('productoNombre').value,
                descripcion: document.getElementById('productoDescripcion').value,
                precio: parseFloat(document.getElementById('productoPrecio').value),
                stock: parseInt(document.getElementById('productoStock').value)
            };

            try {
                const token = localStorage.getItem('authToken');
                const url = productoId 
                    ? `http://localhost:8088/api/productos/${productoId}`
                    : 'http://localhost:8088/api/productos';
                
                const method = productoId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    showAlert(productoId ? 'Producto actualizado' : 'Producto creado', 'success');
                    cerrarModalProducto();
                    cargarProductos();
                    cargarEstadisticas();
                } else {
                    const error = await response.json();
                    showAlert(error.message || 'Error al guardar producto', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('Error de conexión', 'error');
            }
        });

        async function eliminarProducto(id) {
            if (!confirm('¿Estás seguro de eliminar este producto?')) return;

            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`http://localhost:8088/api/productos/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    showAlert('Producto eliminado', 'success');
                    cargarProductos();
                    cargarEstadisticas();
                } else {
                    showAlert('Error al eliminar producto', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('Error de conexión', 'error');
            }
        }

        // ===== UTILIDADES =====
        function showAlert(message, type) {
            const alertDiv = document.getElementById('alert');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            alertDiv.style.display = 'block';
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 5000);
        }

        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('usuario');
            window.location.href = '/login';
        }

        // Cerrar modales al hacer click fuera
        window.onclick = function(event) {
            const modales = ['modalUsuario', 'modalProfesional', 'modalServicio', 'modalCita', 'modalProducto'];
            modales.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target == modal) {
                    modal.style.display = 'none';
                }
            });
        }
    </script>
</body>
</html>
