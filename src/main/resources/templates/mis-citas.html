<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mis Citas - Neita's Barber Shop</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <style>
        .citas-page {
            padding: 60px 0;
            min-height: 100vh;
            background-color: var(--color-bg);
        }
        
        .page-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .page-header h1 {
            font-size: 2.5rem;
            color: var(--color-secondary);
        }
        
        .header-actions {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .tabs {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .tab {
            padding: 12px 30px;
            background-color: var(--color-light);
            border: 2px solid var(--color-border);
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }
        
        .tab.active {
            background-color: var(--color-primary);
            color: var(--color-secondary);
            border-color: var(--color-primary);
        }
        
        .citas-list {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .cita-card {
            background-color: var(--color-light);
            padding: 25px;
            margin-bottom: 20px;
            border: 2px solid var(--color-border);
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .cita-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        
        .cita-info h3 {
            color: var(--color-secondary);
            margin-bottom: 10px;
        }
        
        .cita-details {
            color: var(--color-text);
            line-height: 1.8;
        }
        
        .cita-estado {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            margin-top: 10px;
        }
        
        .estado-pendiente { background-color: #ffc107; color: #000; }
        .estado-confirmada { background-color: #17a2b8; color: #fff; }
        .estado-completada { background-color: #28a745; color: #fff; }
        .estado-cancelada { background-color: #dc3545; color: #fff; }
        
        .cita-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background-color: var(--color-primary);
            color: var(--color-secondary);
        }
        
        .btn-primary:hover {
            background-color: var(--color-accent);
            color: var(--color-light);
        }
        
        .btn-secondary {
            background-color: var(--color-accent);
            color: var(--color-light);
        }
        
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c82333;
        }
        
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #218838;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--color-text);
        }
        
        .empty-state p {
            font-size: 1.2rem;
            margin-bottom: 20px;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: var(--color-light);
            margin: 5% auto;
            padding: 30px;
            border: 2px solid var(--color-border);
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 85vh;
            overflow-y: auto;
        }
        
        .close {
            color: var(--color-text);
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: var(--color-primary);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--color-secondary);
            font-weight: bold;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--color-border);
            border-radius: 5px;
            font-size: 14px;
        }
        
        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            display: none;
        }
        
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .logout-btn {
            background-color: #dc3545;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .logout-btn:hover {
            background-color: #c82333;
        }
        
        .barbero-card {
            background: var(--color-light);
            border: 2px solid var(--color-border);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .barbero-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .barbero-card.selected {
            border-color: var(--color-primary);
            background-color: rgba(212, 175, 55, 0.1);
        }
        
        .barbero-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .barbero-nombre {
            font-weight: bold;
            color: var(--color-secondary);
        }
        
        .barbero-precio {
            color: var(--color-primary);
            font-weight: bold;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <nav class="navbar">
                <div class="logo">
                    <h1>Neita's</h1>
                    <span>BARBER SHOP</span>
                </div>
                <ul class="nav-menu" id="navMenu">
                    <li><a href="/">Inicio</a></li>
                    <li><a href="/servicios">Servicios</a></li>
                    <li><a href="/profesionales">Barberos</a></li>
                    <li><a href="/galeria">Galería</a></li>
                    <li><a href="/productos">Productos</a></li>
                    <li><a href="/mis-citas" class="btn-login">Mis Citas</a></li>
                    <li><button onclick="logout()" class="logout-btn">Cerrar Sesión</button></li>
                </ul>
            </nav>
        </div>
    </header>

    <section class="citas-page">
        <div class="container">
            <div class="page-header">
                <h1>Mis Citas</h1>
                <p id="welcomeMessage">Gestiona tus citas</p>
            </div>

            <!-- Alert -->
            <div id="alert" class="alert"></div>

            <!-- Header Actions -->
            <div class="header-actions">
                <button class="btn btn-success" onclick="abrirModalNuevaCita()">+ Nueva Cita</button>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <div class="tab active" onclick="cambiarTab('proximas')">Próximas</div>
                <div class="tab" onclick="cambiarTab('historial')">Historial</div>
            </div>

            <!-- Citas Próximas -->
            <div id="tab-proximas" class="citas-list">
                <div class="empty-state">
                    <p>Cargando citas...</p>
                </div>
            </div>

            <!-- Historial -->
            <div id="tab-historial" class="citas-list" style="display: none;">
                <div class="empty-state">
                    <p>Cargando historial...</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Modal Nueva/Editar Cita -->
    <div id="modalCita" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModalCita()">&times;</span>
            <h2 id="tituloModal">Nueva Cita</h2>
            <form id="formCita">
                <input type="hidden" id="citaId">
                
                <div class="form-group">
                    <label for="servicioSelect">Servicio *</label>
                    <select id="servicioSelect" required onchange="cargarBarberosPorServicio()">
                        <option value="">Seleccione un servicio</option>
                    </select>
                </div>
                
                <div class="form-group" id="barberosContainer" style="display: none;">
                    <label>Seleccione un Barbero *</label>
                    <div id="barberosList"></div>
                </div>
                
                <div class="form-group">
                    <label for="fechaHora">Fecha y Hora *</label>
                    <input type="datetime-local" id="fechaHora" required>
                </div>
                
                <div class="btn-group" style="display: flex; gap: 10px;">
                    <button type="submit" class="btn btn-primary">Guardar</button>
                    <button type="button" class="btn btn-secondary" onclick="cerrarModalCita()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <script th:src="@{/js/main.js}"></script>
    <script>
        let usuarioData = null;
        let citasProximas = [];
        let citasHistorial = [];
        let barberoSeleccionado = null;

        // Verificar autenticación
        window.addEventListener('DOMContentLoaded', () => {
            const usuarioStr = localStorage.getItem('usuario');
            if (!usuarioStr) {
                window.location.href = '/login';
                return;
            }

            usuarioData = JSON.parse(usuarioStr);
            document.getElementById('welcomeMessage').textContent = `Bienvenido, ${usuarioData.nombre}`;
            
            cargarDatos();
        });

        async function cargarDatos() {
            await Promise.all([
                cargarCitasProximas(),
                cargarCitasHistorial(),
                cargarServicios()
            ]);
        }

        async function cargarCitasProximas() {
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`http://localhost:8088/api/citas/usuario/${usuarioData.usuarioId}/proximas`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    citasProximas = await response.json();
                    mostrarCitasProximas();
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function cargarCitasHistorial() {
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`http://localhost:8088/api/citas/usuario/${usuarioData.usuarioId}/historial`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    citasHistorial = await response.json();
                    mostrarCitasHistorial();
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function mostrarCitasProximas() {
            const container = document.getElementById('tab-proximas');
            
            if (citasProximas.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>No tienes citas próximas</p>
                        <button class="btn btn-primary" onclick="abrirModalNuevaCita()">Agendar Primera Cita</button>
                    </div>
                `;
                return;
            }

            let html = '';
            citasProximas.forEach(cita => {
                const fecha = new Date(cita.fechaHora);
                const estadoClass = `estado-${cita.estado.toLowerCase()}`;
                const puedeEditar = cita.estado === 'PENDIENTE';
                
                html += `
                    <div class="cita-card">
                        <div class="cita-info">
                            <h3>${cita.servicioNombre}</h3>
                            <div class="cita-details">
                                <p><strong>Barbero:</strong> ${cita.profesionalNombre}</p>
                                <p><strong>Fecha:</strong> ${fecha.toLocaleDateString('es-CO')}</p>
                                <p><strong>Hora:</strong> ${fecha.toLocaleTimeString('es-CO', {hour: '2-digit', minute: '2-digit'})}</p>
                                <span class="cita-estado ${estadoClass}">${cita.estado}</span>
                            </div>
                        </div>
                        <div class="cita-actions">
                            ${puedeEditar ? `<button class="btn btn-secondary" onclick="editarCita(${cita.id})">Editar</button>` : ''}
                            ${puedeEditar ? `<button class="btn btn-danger" onclick="cancelarCita(${cita.id})">Cancelar</button>` : ''}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function mostrarCitasHistorial() {
            const container = document.getElementById('tab-historial');
            
            if (citasHistorial.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>No tienes citas en el historial</p>
                    </div>
                `;
                return;
            }

            let html = '';
            citasHistorial.forEach(cita => {
                const fecha = new Date(cita.fechaHora);
                const estadoClass = `estado-${cita.estado.toLowerCase()}`;
                
                html += `
                    <div class="cita-card">
                        <div class="cita-info">
                            <h3>${cita.servicioNombre}</h3>
                            <div class="cita-details">
                                <p><strong>Barbero:</strong> ${cita.profesionalNombre}</p>
                                <p><strong>Fecha:</strong> ${fecha.toLocaleDateString('es-CO')}</p>
                                <p><strong>Hora:</strong> ${fecha.toLocaleTimeString('es-CO', {hour: '2-digit', minute: '2-digit'})}</p>
                                <span class="cita-estado ${estadoClass}">${cita.estado}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function cambiarTab(tab) {
            // Ocultar todos los tabs
            document.getElementById('tab-proximas').style.display = 'none';
            document.getElementById('tab-historial').style.display = 'none';
            
            // Remover clase active de todos los tabs
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            
            // Mostrar tab seleccionado
            if (tab === 'proximas') {
                document.getElementById('tab-proximas').style.display = 'block';
                event.target.classList.add('active');
            } else {
                document.getElementById('tab-historial').style.display = 'block';
                event.target.classList.add('active');
            }
        }

        async function cargarServicios() {
            try {
                const response = await fetch('http://localhost:8088/api/servicios/activos');
                if (response.ok) {
                    const servicios = await response.json();
                    const select = document.getElementById('servicioSelect');
                    select.innerHTML = '<option value="">Seleccione un servicio</option>';
                    servicios.forEach(servicio => {
                        select.innerHTML += `<option value="${servicio.id}">${servicio.nombre} - ${servicio.duracion} - $${servicio.precio.toLocaleString('es-CO')}</option>`;
                    });
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function cargarBarberosPorServicio() {
            const servicioId = document.getElementById('servicioSelect').value;
            
            if (!servicioId) {
                document.getElementById('barberosContainer').style.display = 'none';
                return;
            }

            try {
                const response = await fetch(`http://localhost:8088/api/barbero-servicios/servicio/${servicioId}/disponibles`);
                if (response.ok) {
                    const barberos = await response.json();
                    mostrarBarberos(barberos);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function mostrarBarberos(barberos) {
            const container = document.getElementById('barberosList');
            
            if (barberos.length === 0) {
                container.innerHTML = '<p>No hay barberos disponibles para este servicio</p>';
                document.getElementById('barberosContainer').style.display = 'block';
                return;
            }

            let html = '';
            barberos.forEach(barbero => {
                html += `
                    <div class="barbero-card" onclick="seleccionarBarbero(${barbero.profesionalId}, ${barbero.id}, this)">
                        <div class="barbero-info">
                            <div>
                                <div class="barbero-nombre">${barbero.profesionalNombre}</div>
                                <small>${barbero.profesionalEspecialidad}</small>
                            </div>
                            <div class="barbero-precio">$${barbero.precioPersonalizado.toLocaleString('es-CO')}</div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            document.getElementById('barberosContainer').style.display = 'block';
        }

        function seleccionarBarbero(profesionalId, barberoServicioId, element) {
            // Remover selección anterior
            document.querySelectorAll('.barbero-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Marcar como seleccionado
            element.classList.add('selected');
            barberoSeleccionado = { profesionalId, barberoServicioId };
        }

        function abrirModalNuevaCita() {
            document.getElementById('tituloModal').textContent = 'Nueva Cita';
            document.getElementById('formCita').reset();
            document.getElementById('citaId').value = '';
            document.getElementById('barberosContainer').style.display = 'none';
            barberoSeleccionado = null;
            
            // Establecer fecha mínima (hoy)
            const ahora = new Date();
            ahora.setMinutes(ahora.getMinutes() - ahora.getTimezoneOffset());
            document.getElementById('fechaHora').min = ahora.toISOString().slice(0, 16);
            
            document.getElementById('modalCita').style.display = 'block';
        }

        function cerrarModalCita() {
            document.getElementById('modalCita').style.display = 'none';
        }

        async function editarCita(citaId) {
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`http://localhost:8088/api/citas/${citaId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const cita = await response.json();
                    document.getElementById('tituloModal').textContent = 'Editar Cita';
                    document.getElementById('citaId').value = cita.id;
                    document.getElementById('servicioSelect').value = cita.servicioId;
                    
                    // Cargar barberos del servicio
                    await cargarBarberosPorServicio();
                    
                    // Seleccionar barbero actual
                    barberoSeleccionado = { 
                        profesionalId: cita.profesionalId,
                        barberoServicioId: cita.barberoServicioId 
                    };
                    
                    // Marcar barbero seleccionado
                    setTimeout(() => {
                        const barberoCards = document.querySelectorAll('.barbero-card');
                        barberoCards.forEach(card => {
                            if (card.onclick.toString().includes(cita.profesionalId)) {
                                card.classList.add('selected');
                            }
                        });
                    }, 100);
                    
                    // Establecer fecha
                    const fecha = new Date(cita.fechaHora);
                    fecha.setMinutes(fecha.getMinutes() - fecha.getTimezoneOffset());
                    document.getElementById('fechaHora').value = fecha.toISOString().slice(0, 16);
                    
                    document.getElementById('modalCita').style.display = 'block';
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('Error al cargar cita', 'error');
            }
        }

        document.getElementById('formCita').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!barberoSeleccionado) {
                showAlert('Por favor seleccione un barbero', 'error');
                return;
            }
            
            const citaId = document.getElementById('citaId').value;
            const servicioId = parseInt(document.getElementById('servicioSelect').value);
            const fechaHora = document.getElementById('fechaHora').value;
            
            const data = {
                usuarioId: usuarioData.usuarioId,
                profesionalId: barberoSeleccionado.profesionalId,
                servicioId: servicioId,
                fechaHora: fechaHora,
                estado: 'PENDIENTE'
            };

            try {
                const token = localStorage.getItem('authToken');
                const url = citaId 
                    ? `http://localhost:8088/api/citas/${citaId}`
                    : 'http://localhost:8088/api/citas';
                
                const method = citaId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    showAlert(citaId ? 'Cita actualizada exitosamente' : 'Cita creada exitosamente', 'success');
                    cerrarModalCita();
                    cargarCitasProximas();
                } else {
                    const error = await response.json();
                    showAlert(error.message || 'Error al guardar cita', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('Error de conexión', 'error');
            }
        });

        async function cancelarCita(citaId) {
            if (!confirm('¿Estás seguro de cancelar esta cita?')) return;

            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`http://localhost:8088/api/citas/${citaId}/cancelar`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    showAlert('Cita cancelada exitosamente', 'success');
                    cargarCitasProximas();
                    cargarCitasHistorial();
                } else {
                    showAlert('Error al cancelar cita', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('Error de conexión', 'error');
            }
        }

        function showAlert(message, type) {
            const alertDiv = document.getElementById('alert');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            alertDiv.style.display = 'block';
            window.scrollTo({ top: 0, behavior: 'smooth' });
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 5000);
        }

        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('usuario');
            window.location.href = '/login';
        }

        // Cerrar modal al hacer click fuera
        window.onclick = function(event) {
            const modal = document.getElementById('modalCita');
            if (event.target == modal) {
                cerrarModalCita();
            }
        }
    </script>
</body>
</html>
